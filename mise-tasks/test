#!/usr/bin/env bash
set -euo pipefail

# Check if JSON Schema Test Suite submodule is initialized
if [ ! -d "jsonschema/oas3/tests/testsuite/tests/draft2020-12" ] || [ -z "$(ls -A jsonschema/oas3/tests/testsuite/tests/draft2020-12 2>/dev/null)" ]; then
    echo "⚠️  JSON Schema Test Suite submodule not initialized."
    echo "   Some tests will be skipped. Run 'mise run setup-submodules' to enable all tests."
    echo ""
fi

# If arguments are provided, use them as the package path(s)
# Otherwise, run all tests
if [ $# -gt 0 ]; then
    echo "🧪 Running tests for specified packages with gotestsum..."
    gotestsum --format testname -- -race "$@"
else
    echo "🧪 Running tests with gotestsum..."
    gotestsum --format testname -- -race ./...

    echo "🧪 Running tests in separate modules..."
    (cd jsonschema/oas3/tests && GOWORK=off gotestsum --format testname -- -race ./...)
fi

echo "✅ All tests passed!"